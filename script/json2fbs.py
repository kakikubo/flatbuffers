#! /usr/bin/env python
# -*- coding: utf-8 -*-

import sys
import codecs
import json
import re
import datetime
import argparse
import logging
from logging import info, warning, error
from collections import OrderedDict

def split_attributes(str):
    m = re.match("([^\(\)]+)\s*(\(.*\))", str)
    if m == None:
        return (str,"")
    else:
        return (m.group(1), " " + m.group(2))

def generate_fbs(rootName, nameSpace, jsonData):
    s = "// generated by json2fbs.py\n\n"

    # output namespace
    s += "namespace {0};\n".format(nameSpace)

    # output tables
    for table_name in jsonData:
        if table_name == "_meta":
            s += 'table ' + rootName[0:1].upper() + rootName[1:] + " {\n"
            for item in jsonData[table_name]:
                name = item["name"]
                item_type, item_attributes = split_attributes(item["type"])
                table_name = name[0:1].upper() + name[1:]
                if item_type.find("array") >= 0:
                    s += "    " + name + ":[" + table_name + "]" + item_attributes + ";\n"
                else:
                    s += "    " + name + ":" + table_name + item_attributes + ";\n"
            s += "}\n\n"
        else:
            s += 'table ' + table_name[0:1].upper() + table_name[1:] + " {\n"
            for item in jsonData[table_name]:
                item_type, item_attributes = split_attributes(item["type"])
                s += "    " + item["name"] + ":" + item_type + item_attributes + ";\n"
            s += "}\n\n"

    # output root_type
    s += 'root_type {0};'.format(rootName)+"\n"
    return s

# ---
# root function
#
def json2fbs(input_json, output_fbs, rootName, nameSpace):
    with open(input_json, 'r') as f:
        jsonData = json.loads(f.read(), object_pairs_hook=OrderedDict)
        if isinstance(jsonData, dict):
            s = generate_fbs(rootName, nameSpace, jsonData)
            with open(output_fbs, 'w') as f:
                f.write(s)
        else:
            print 'unsupported format. params:[{0}][{1}][{2}]'.format(input_json, rootName, nameSpace)

# ---
# main function
#
if __name__ == '__main__':
    sys.stdout = codecs.lookup('utf_8')[-1](sys.stdout)
    logging.basicConfig(level = logging.INFO, format = '%(asctime)-15s %(levelname)s %(message)s')
    parser = argparse.ArgumentParser(description = 'generate flatbuffers schema file (fbs) from json')
    parser.add_argument('input_json',  metavar = 'input.json',    help = 'input schema json file')
    parser.add_argument('output_fbs',  metavar = 'output.fbs',    help = 'output fbs file')
    parser.add_argument('--root-name', default = 'MasterDataFBS', help = 'root node of flat buffers')
    parser.add_argument('--namespace', default = 'kms.fbs',       help = 'name space')
    args = parser.parse_args()

    info("input.json = %s" % args.input_json)
    info("output.fbs = %s" % args.output_fbs)
    info("root name = %s" % args.root_name)
    info("namespace = %s" % args.namespace)
    json2fbs(args.input_json, args.output_fbs, args.root_name, args.namespace)
    exit(0)
